# WebRTC 視訊聊天室項目

## 項目概述
這是一個基於 Janus Gateway 的多人視訊聊天室應用，支援 20-50 人同時在線視訊通話和即時文字聊天。

## 技術棧
- **前端**: HTML5 + JavaScript + WebRTC API
- **媒體伺服器**: Janus Gateway
- **通訊協議**: WebSocket (ws://192.168.6.70:8188)
- **Janus 插件**: VideoRoom (用於媒體流和聊天)

## 核心功能
- ✅ 多人視訊通話 (20-50 人同時在線)
- ✅ 高品質音訊傳輸
- ✅ 動態視訊品質調整
- ✅ 音訊/視訊控制 (靜音、關閉攝影機)
- ✅ 即時文字聊天
- ✅ 用戶管理 (加入/離開、用戶計數)
- ✅ 響應式 UI 設計

## 檔案結構
```
lab-webrtc-sample-2/
├── index.html          # 主應用程序
├── janus.js           # Janus Gateway 客戶端庫
├── requirement.md     # 需求分析與實現狀態
└── .claude/
    └── CLAUDE.md      # 本文件
```

## 關鍵技術決策

### 聊天方案選擇
- **初始方案**: Janus TextRoom 插件
- **問題**: TextRoom 0.0.2 不支援多用戶聊天
- **最終方案**: VideoRoom display 屬性更新機制
- **優勢**: 統一在單一插件內處理媒體流和聊天

### 訊息可靠性
- 使用 UUID v7 進行訊息去重
- 實現重複發送機制確保訊息送達
- 定期清理過期訊息防止記憶體洩漏

### 狀態同步
- 音訊/視訊狀態變更自動同步到 Janus 服務器
- 所有用戶即時接收狀態更新
- 視訊關閉時顯示友好提示覆蓋層

## 開發歷程與問題解決

### 主要挑戰
1. **TextRoom 插件限制**
   - 發現 TextRoom 0.0.2 API 不完整
   - 改用 VideoRoom display 屬性實現聊天

2. **訊息丟失問題**
   - WebSocket 網路抖動導致訊息丟失
   - 實現訊息重複發送和去重機制

3. **代碼結構問題**
   - 初期存在 TextRoom 和 VideoRoom 混合代碼
   - 進行大規模重構，移除所有 TextRoom 相關代碼

4. **用戶體驗優化**
   - 視訊關閉時避免黑屏
   - 添加狀態指示和友好提示

### 解決方案演進
1. **v1.0**: 基礎 VideoRoom 功能
2. **v2.0**: 添加 TextRoom 聊天支持
3. **v3.0**: 發現 TextRoom 限制，回退至 VideoRoom
4. **v4.0**: 優化 VideoRoom display 聊天方案
5. **v5.0**: 訊息可靠性改進和代碼清理

## 使用說明

### 環境需求
- 現代瀏覽器 (Chrome, Firefox, Safari, Edge)
- Janus Gateway 服務器 (ws://192.168.6.70:8188)
- HTTPS 環境 (用於 getUserMedia API)

### 啟動步驟
1. 確保 Janus Gateway 服務器運行
2. 開啟 index.html 文件
3. 允許瀏覽器攝影機/麥克風權限
4. 點擊「加入聊天室」開始使用

### 功能操作
- **加入房間**: 自動分配用戶 ID 並加入預設房間 1234
- **視訊控制**: 點擊「開/關攝影機」按鈕
- **音訊控制**: 點擊「靜音/取消靜音」按鈕
- **文字聊天**: 在聊天框輸入訊息並發送
- **離開房間**: 點擊「離開聊天室」按鈕

## 維護與擴展

### 日誌系統
- 分級日誌: INFO (重要資訊), DEBUG (除錯訊息), ERROR (錯誤)
- 瀏覽器控制台查看詳細日誌
- 生產環境建議調整日誌級別

### 效能監控
- 監控同時在線用戶數量
- 觀察網路連接狀態
- 檢查記憶體使用情況

### 可能的擴展
- 添加用戶認證系統
- 實現多房間支持
- 添加檔案分享功能
- 整合錄製功能
- 移動端優化

## 已知限制
- 依賴特定 Janus Gateway 配置
- 房間密碼硬編碼 (room-1234: "adminpwd")
- 單一房間設計 (可擴展為多房間)
- 無持久化聊天記錄

## 聯絡資訊
- 項目開發: Claude Code Assistant
- 技術支持: 參考 Janus Gateway 官方文檔
- 問題回報: 檢查瀏覽器控制台錯誤訊息

## 版本資訊
- 當前版本: 5.0
- 最後更新: 2025-01-28
- 狀態: 穩定版本，已完成核心功能