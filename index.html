<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC è¦–è¨ŠèŠå¤©å®¤ - Janus Gateway Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        .video-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }
        video {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #000;
        }
        .video-disabled {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            z-index: 10;
            text-align: center;
            line-height: 1.4;
        }
        .video-disabled strong {
            font-size: 18px;
            margin: 5px 0;
        }
        .video-disabled small {
            font-size: 14px;
            opacity: 0.8;
        }
        .video-label {
            padding: 10px;
            text-align: center;
            font-weight: bold;
            color: #333;
            background: rgba(255, 255, 255, 0.9);
            position: relative;
            z-index: 20;
        }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
        }
        .status-disconnected { background: #f8d7da; color: #721c24; }
        .status-connecting { background: #fff3cd; color: #856404; }
        .status-connected { background: #d4edda; color: #155724; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 5px;
            height: 200px;
            overflow-y: scroll;
            font-family: monospace;
            font-size: 12px;
        }
        input[type="text"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px;
        }
        
        /* èŠå¤©å€åŸŸæ¨£å¼ */
        .chat-container {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: 500px;
            display: flex;
            flex-direction: column;
        }
        .chat-messages {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            overflow-y: auto;
            background: #fafafa;
            margin-bottom: 10px;
        }
        .chat-input-area {
            display: flex;
            gap: 10px;
        }
        .chat-input-area input {
            flex: 1;
            margin: 0;
        }
        .chat-input-area button {
            margin: 0;
        }
        .chat-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 80%;
            word-wrap: break-word;
        }
        .chat-message.own {
            background: #007bff;
            color: white;
            margin-left: auto;
            text-align: right;
        }
        .chat-message.other {
            background: #e9ecef;
            color: #333;
        }
        .chat-message .sender {
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 4px;
        }
        .chat-message .content {
            font-size: 14px;
        }
        .chat-message .time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>WebRTC è¦–è¨ŠèŠå¤©å®¤</h1>
        
        <!-- é€£æ¥ç‹€æ…‹ -->
        <div id="status" class="status status-disconnected">
            æœªé€£æ¥åˆ°ä¼ºæœå™¨
        </div>
        
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="controls">
            <div>
                <label>æˆ¿é–“ ID: </label>
                <input type="text" id="roomId" value="1234" placeholder="è¼¸å…¥æˆ¿é–“è™Ÿç¢¼">
                <button id="joinBtn" class="btn btn-success">åŠ å…¥æˆ¿é–“</button>
                <button id="leaveBtn" class="btn btn-danger" disabled>é›¢é–‹æˆ¿é–“</button>
            </div>
            <div id="roomInfo" style="margin-top: 10px; padding: 10px; background-color: #e9ecef; border-radius: 5px; display: none;">
                <strong>æˆ¿é–“ç‹€æ…‹ï¼š</strong>
                <div id="roomStatus">æœªåŠ å…¥æˆ¿é–“</div>
            </div>
            <div>
                <button id="muteBtn" class="btn btn-primary" disabled>éœéŸ³</button>
                <button id="videoBtn" class="btn btn-primary" disabled>é—œé–‰è¦–è¨Š</button>
            </div>
        </div>
        
        <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
        <div style="display: flex; gap: 20px;">
            <!-- è¦–è¨Šå€åŸŸ -->
            <div style="flex: 2;">
                <div class="video-grid" id="videoGrid">
                    <!-- æœ¬åœ°è¦–è¨Š -->
                    <div class="video-container" id="localVideoContainer">
                        <video id="localVideo" autoplay muted playsinline></video>
                        <div id="localVideoDisabled" class="video-disabled" style="display: none;">
                            ğŸ“·<br>
                            <strong>æˆ‘çš„è¦–è¨Š</strong><br>
                            <small>è¦–è¨Šå·²é—œé–‰</small>
                        </div>
                        <div class="video-label">æˆ‘çš„è¦–è¨Š</div>
                    </div>
                </div>
            </div>
            
            <!-- èŠå¤©å€åŸŸ -->
            <div style="flex: 1; min-width: 300px;">
                <div class="chat-container">
                    <h3>èŠå¤©å®¤</h3>
                    <div id="chatMessages" class="chat-messages"></div>
                    <div class="chat-input-area">
                        <input type="text" id="chatInput" placeholder="è¼¸å…¥è¨Šæ¯..." disabled>
                        <button id="sendBtn" class="btn btn-primary" disabled>ç™¼é€</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ—¥èªŒ -->
        <h3>é€£æ¥æ—¥èªŒ</h3>
        <div id="log" class="log"></div>
    </div>

    <!-- å¼•å…¥ WebRTC Adapter (Janus ä¾è³´) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/8.2.2/adapter.min.js"></script>
    
    <!-- å¼•å…¥ Janus Gateway JavaScript åº« (æœ¬åœ°ç‰ˆæœ¬) -->
    <script src="http://192.168.6.70:8081/janus.js"></script>
    
    <script>
        // å…¨åŸŸè®Šæ•¸
        let janus = null;
        
        // Log level è¨­å®š
        const LOG_LEVELS = {
            ERROR: 0,
            WARN: 1,
            INFO: 2,
            DEBUG: 3
        };
        
        const CURRENT_LOG_LEVEL = LOG_LEVELS.INFO; // è¨­ç‚º INFO æ¸›å°‘ä¸å¿…è¦çš„ debug è¨Šæ¯
        let videoRoomHandle = null;
        let localStream = null;
        let remoteStreams = {};
        let isAudioMuted = false;
        let isVideoMuted = false;
        let currentRoomId = null;
        let roomParticipants = new Set(); // è¿½è¹¤æˆ¿é–“å…§çš„ç”¨æˆ¶
        let currentUserId = null;
        let currentUserName = null;
        let textRoomHandle = null;
        let textRoomDataChannelOpen = false;
        
        // è¨Šæ¯å»é‡ç³»çµ±
        const processedMessages = new Map(); // è¿½è¹¤å·²è™•ç†çš„è¨Šæ¯
        let displayRestoreTimeout = null; // è¿½è¹¤ display æ¢å¾© timeout
        
        // ç”Ÿæˆ UUID v7 (æ™‚é–“æˆ³ + éš¨æ©Ÿ)
        function generateUUIDv7() {
            const timestamp = Date.now();
            const timestampHex = timestamp.toString(16).padStart(12, '0');
            const randomHex = Array.from({length: 20}, () => 
                Math.floor(Math.random() * 16).toString(16)
            ).join('');
            
            return `${timestampHex.slice(0,8)}-${timestampHex.slice(8,12)}-7${randomHex.slice(0,3)}-${randomHex.slice(3,7)}-${randomHex.slice(7,19)}`;
        }
        
        // æ¸…ç†éæœŸçš„è¨Šæ¯è¨˜éŒ„ï¼ˆé˜²æ­¢è¨˜æ†¶é«”æ´©æ¼ï¼‰
        function cleanupOldMessages() {
            const now = Date.now();
            const expireTime = 5 * 60 * 1000; // 5åˆ†é˜
            
            for (const [key, timestamp] of processedMessages.entries()) {
                if (now - timestamp > expireTime) {
                    processedMessages.delete(key);
                }
            }
        }
        
        // å®šæœŸæ¸…ç†éæœŸè¨Šæ¯
        setInterval(cleanupOldMessages, 60 * 1000); // æ¯åˆ†é˜æ¸…ç†ä¸€æ¬¡
        
        // TextRoom é…ç½®
        // ä½ çš„é…ç½®ä¸­ room-1234 æœ‰ secret = "adminpwd"
        function getRoomSecret(roomId) {
            if (roomId == 1234) {
                return "adminpwd";
            }
            return null; // å…¶ä»–æˆ¿é–“ä¸éœ€è¦å¯†é‘°
        }
        
        // DOM å…ƒç´ 
        const statusDiv = document.getElementById('status');
        const joinBtn = document.getElementById('joinBtn');
        const leaveBtn = document.getElementById('leaveBtn');
        const muteBtn = document.getElementById('muteBtn');
        const videoBtn = document.getElementById('videoBtn');
        const roomIdInput = document.getElementById('roomId');
        const localVideo = document.getElementById('localVideo');
        const localVideoDisabled = document.getElementById('localVideoDisabled');
        const videoGrid = document.getElementById('videoGrid');
        const logDiv = document.getElementById('log');
        const roomInfo = document.getElementById('roomInfo');
        const roomStatus = document.getElementById('roomStatus');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        
        // æ—¥èªŒå‡½æ•¸
        function log(message, level = LOG_LEVELS.INFO) {
            if (level <= CURRENT_LOG_LEVEL) {
                const timestamp = new Date().toLocaleTimeString();
                const levelName = Object.keys(LOG_LEVELS)[level];
                logDiv.innerHTML += `[${timestamp}] [${levelName}] ${message}<br>`;
                logDiv.scrollTop = logDiv.scrollHeight;
                
                switch(level) {
                    case LOG_LEVELS.ERROR:
                        console.error(message);
                        break;
                    case LOG_LEVELS.WARN:
                        console.warn(message);
                        break;
                    case LOG_LEVELS.DEBUG:
                        console.debug(message);
                        break;
                    default:
                        console.log(message);
                }
            }
        }
        
        // æ›´æ–°ç‹€æ…‹
        function updateStatus(status, className) {
            statusDiv.textContent = status;
            statusDiv.className = `status ${className}`;
        }
        
        // æ›´æ–°æˆ¿é–“ç‹€æ…‹
        function updateRoomStatus(message, show = true) {
            roomStatus.innerHTML = message;
            roomInfo.style.display = show ? 'block' : 'none';
        }
        
        // æ›´æ–°æˆ¿é–“äººæ•¸
        function updateRoomParticipants() {
            if (currentRoomId) {
                const participantCount = roomParticipants.size + 1; // +1 åŒ…å«è‡ªå·±
                updateRoomStatus(`å·²åŠ å…¥æˆ¿é–“ ${currentRoomId}<br>æˆ¿é–“å…§å…± ${participantCount} äºº`);
            }
        }
        
        // æª¢æŸ¥ Janus æ˜¯å¦å·²è¼‰å…¥
        function checkJanusLoaded() {
            if (typeof Janus === 'undefined') {
                log('éŒ¯èª¤: Janus Gateway åº«æœªæ­£ç¢ºè¼‰å…¥', LOG_LEVELS.ERROR);
                updateStatus('åº«è¼‰å…¥å¤±æ•—', 'status-disconnected');
                return false;
            }
            return true;
        }
        
        // åˆå§‹åŒ– Janus Gateway
        function initJanus() {
            // æª¢æŸ¥ Janus åº«æ˜¯å¦è¼‰å…¥
            if (!checkJanusLoaded()) {
                setTimeout(initJanus, 1000); // 1ç§’å¾Œé‡è©¦
                return;
            }
            
            
            // åˆå§‹åŒ– Janus åº«
            Janus.init({
                debug: false, // é—œé–‰èª¿è©¦æ¨¡å¼
                callback: function() {
                    log('å·²é€£æ¥åˆ° Janus Gateway');
                    startJanusConnection();
                }
            });
        }
        
        // é–‹å§‹ Janus é€£æ¥
        function startJanusConnection() {
            updateStatus('æ­£åœ¨é€£æ¥...', 'status-connecting');
            
            janus = new Janus({
                server: 'ws://192.168.6.70:8188',
                success: function() {
                    updateStatus('å·²é€£æ¥åˆ°ä¼ºæœå™¨', 'status-connected');
                    joinBtn.disabled = false;
                    
                },
                error: function(error) {
                    log('é€£æ¥å¤±æ•—: ' + error, LOG_LEVELS.ERROR);
                    updateStatus('é€£æ¥å¤±æ•—', 'status-disconnected');
                },
                destroyed: function() {
                    updateStatus('é€£æ¥å·²é—œé–‰', 'status-disconnected');
                    resetUI();
                }
            });
        }
        
        
        // é‡ç½® UI
        function resetUI() {
            joinBtn.disabled = false;
            leaveBtn.disabled = true;
            muteBtn.disabled = true;
            videoBtn.disabled = true;
        }
        
        // åŠ å…¥æˆ¿é–“
        function joinRoom() {
            const roomId = parseInt(roomIdInput.value);
            if (!roomId) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æˆ¿é–“è™Ÿç¢¼');
                return;
            }
            
            if (!janus) {
                log('éŒ¯èª¤: æœªé€£æ¥åˆ° Janus Gateway');
                alert('è«‹å…ˆç­‰å¾…é€£æ¥åˆ°ä¼ºæœå™¨');
                return;
            }
            
            log(`æ­£åœ¨åŠ å…¥æˆ¿é–“ ${roomId}...`, LOG_LEVELS.DEBUG);
            
            janus.attach({
                plugin: 'janus.plugin.videoroom',
                success: function(pluginHandle) {
                    videoRoomHandle = pluginHandle;
                    
                    // å‰µå»ºæˆ¿é–“ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
                    const createMsg = {
                        request: 'create',
                        room: roomId,
                        description: `æˆ¿é–“ ${roomId}`,
                        publishers: 50,
                        is_private: false
                    };
                    
                    videoRoomHandle.send({ 
                        message: createMsg,
                        success: function(result) {
                            joinExistingRoom(roomId);
                        },
                        error: function(error) {
                            joinExistingRoom(roomId); // æˆ¿é–“å¯èƒ½å·²å­˜åœ¨
                        }
                    });
                },
                error: function(error) {
                    log('é™„åŠ æ’ä»¶å¤±æ•—: ' + JSON.stringify(error));
                    alert('ç„¡æ³•é€£æ¥åˆ° VideoRoom æ’ä»¶ï¼Œè«‹æª¢æŸ¥ä¼ºæœå™¨è¨­å®š');
                },
                onmessage: function(msg, jsep) {
                    handleVideoRoomMessage(msg, jsep);
                },
                onlocalstream: function(stream) {
                    log('æ”¶åˆ°æœ¬åœ°åª’é«”æµ', LOG_LEVELS.DEBUG);
                    localStream = stream;
                    localVideo.srcObject = stream;
                    
                    joinBtn.disabled = true;
                    leaveBtn.disabled = false;
                    muteBtn.disabled = false;
                    videoBtn.disabled = false;
                },
                onremotestream: function(stream) {
                    log('æ”¶åˆ°é ç¨‹åª’é«”æµ', LOG_LEVELS.DEBUG);
                    // é€™å€‹æœƒåœ¨ subscriber ä¸­è™•ç†
                }
            });
        }
        
        // åŠ å…¥ç¾æœ‰æˆ¿é–“
        function joinExistingRoom(roomId) {
            currentUserName = 'ç”¨æˆ¶_' + Math.floor(Math.random() * 1000);
            const joinMsg = {
                request: 'join',
                room: roomId,
                ptype: 'publisher',
                display: currentUserName
            };
            
            log(`æ­£åœ¨åŠ å…¥æˆ¿é–“ ${roomId}...`, LOG_LEVELS.DEBUG);
            videoRoomHandle.send({ message: joinMsg });
        }
        
        // è™•ç† VideoRoom æ¶ˆæ¯
        function handleVideoRoomMessage(msg, jsep) {
            const event = msg.videoroom;
            log(`VideoRoom äº‹ä»¶: ${event}, å®Œæ•´è¨Šæ¯: ${JSON.stringify(msg)}`, LOG_LEVELS.DEBUG);
            
            if (event === 'joined') {
                log(`æˆåŠŸåŠ å…¥æˆ¿é–“ ${msg.room}`);
                currentRoomId = msg.room;
                currentUserId = msg.id;
                
                // å•Ÿç”¨èŠå¤©åŠŸèƒ½
                chatInput.disabled = false;
                sendBtn.disabled = false;
                
                // ä¸å†ä½¿ç”¨ TextRoomï¼Œç›´æ¥å•Ÿç”¨ VideoRoom èŠå¤©åŠŸèƒ½
                log('èŠå¤©åŠŸèƒ½å·²å•Ÿç”¨ï¼Œä½¿ç”¨ VideoRoom display æ–¹æ¡ˆ');
                
                // åŒæ™‚è¨­ç½®åŸºæ–¼ Janus WebSocket çš„èŠå¤©å‚™ç”¨æ–¹æ¡ˆ
                
                // æ¸…ç©ºä¸¦é‡æ–°è¨­ç½®æˆ¿é–“åƒèˆ‡è€…
                roomParticipants.clear();
                if (msg.publishers) {
                    msg.publishers.forEach(publisher => {
                        roomParticipants.add(publisher.id);
                    });
                }
                updateRoomParticipants();
                
                // ç²å–æœ¬åœ°åª’é«”ä¸¦ç™¼å¸ƒ
                navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                }).then(function(stream) {
                    localStream = stream;
                    localVideo.srcObject = stream;
                    
                    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                    joinBtn.disabled = true;
                    leaveBtn.disabled = false;
                    muteBtn.disabled = false;
                    videoBtn.disabled = false;
                    
                    videoRoomHandle.createOffer({
                        media: { videoRecv: false, audioRecv: false },
                        stream: stream,
                        success: function(jsep) {
                            const publishMsg = { request: 'configure', audio: true, video: true };
                            videoRoomHandle.send({ message: publishMsg, jsep: jsep });
                        },
                        error: function(error) {
                            log('ç™¼å¸ƒè¦–è¨Šå¤±æ•—: ' + error);
                        }
                    });
                }).catch(function(error) {
                    log('ç„¡æ³•ç²å–æ”å½±æ©Ÿæ¬Šé™: ' + error.message);
                    if (error.name === 'NotAllowedError') {
                        alert('è«‹å…è¨±ä½¿ç”¨æ”å½±æ©Ÿå’Œéº¥å…‹é¢¨æ¬Šé™ï¼');
                    }
                });
                
                // è¨‚é–±ç¾æœ‰ç”¨æˆ¶
                if (msg.publishers) {
                    for (let publisher of msg.publishers) {
                        subscribeToPublisher(publisher.id, publisher.display);
                    }
                }
            } else if (event === 'event') {
                if (msg.publishers) {
                    // æ–°ç”¨æˆ¶åŠ å…¥
                    for (let publisher of msg.publishers) {
                        // æª¢æŸ¥æ˜¯å¦åŒ…å«èŠå¤©è¨Šæ¯
                        processChatMessage(publisher.display, publisher.id);
                        
                        const cleanDisplayName = getCleanDisplayName(publisher.display);
                        log(`${cleanDisplayName} åŠ å…¥æˆ¿é–“`);
                        roomParticipants.add(publisher.id);
                        subscribeToPublisher(publisher.id, cleanDisplayName);
                    }
                    updateRoomParticipants();
                } else if (msg.leaving) {
                    // ç”¨æˆ¶é›¢é–‹
                    log(`ç”¨æˆ¶ ${msg.leaving} é›¢é–‹æˆ¿é–“`);
                    roomParticipants.delete(msg.leaving);
                    removeRemoteVideo(msg.leaving);
                    updateRoomParticipants();
                } else if (msg.configured === 'ok') {
                    // ç”¨æˆ¶é…ç½®æ›´æ–°ï¼ˆå¯èƒ½åŒ…å«èŠå¤©è¨Šæ¯ï¼‰
                    log(`VideoRoom configured äº‹ä»¶: ${JSON.stringify(msg)}`, LOG_LEVELS.DEBUG);
                    if (msg.display) {
                        processChatMessage(msg.display, msg.id);
                    }
                } else if (msg.publishers && msg.publishers.length > 0) {
                    // æª¢æŸ¥ç¾æœ‰ç”¨æˆ¶çš„ display æ›´æ–°ï¼ˆåŒ…å«èŠå¤©è¨Šæ¯ï¼‰
                    for (let publisher of msg.publishers) {
                        if (publisher.display) {
                            log(`æª¢æŸ¥ç”¨æˆ¶ ${publisher.id} display æ›´æ–°: ${publisher.display}`);
                            processChatMessage(publisher.display, publisher.id);
                        }
                    }
                } else if (msg.id && msg.display) {
                    // è™•ç†å–®å€‹ç”¨æˆ¶çš„ display æ›´æ–°äº‹ä»¶
                    log(`å–®å€‹ç”¨æˆ¶ ${msg.id} display æ›´æ–°: ${msg.display}`);
                    processChatMessage(msg.display, msg.id);
                }
            }
            
            // è™•ç†è‡ªå®šç¾©æ–‡å­—è¨Šæ¯
            if (msg.body && msg.body.type === 'chat' && msg.body.message && msg.body.sender) {
                const textMsg = msg.body;
                log(`æ”¶åˆ°è‡ªå®šç¾©èŠå¤©è¨Šæ¯: ${JSON.stringify(textMsg)}`, LOG_LEVELS.DEBUG);
                if (textMsg.sender !== currentUserName) {
                    addChatMessage(textMsg.sender, textMsg.sender, textMsg.message, false);
                    log(`é¡¯ç¤ºä¾†è‡ª ${textMsg.sender} çš„è¨Šæ¯: ${textMsg.message}`);
                } else {
                    log('éæ¿¾è‡ªå·±çš„èŠå¤©è¨Šæ¯');
                }
            } else if (msg.body && msg.body.message && msg.body.username) {
                // å…¼å®¹èˆŠæ ¼å¼
                const textMsg = msg.body;
                if (textMsg.username !== currentUserName) {
                    addChatMessage(textMsg.userId || 'unknown', textMsg.username, textMsg.message, false);
                    log(`æ”¶åˆ°ä¾†è‡ª ${textMsg.username} çš„è¨Šæ¯: ${textMsg.message}`);
                }
            }
            
            // è™•ç† WebRTC ç›¸é—œ
            if (jsep) {
                videoRoomHandle.handleRemoteJsep({ jsep: jsep });
            }
        }
        
        // è¨‚é–±ç™¼å¸ƒè€…
        function subscribeToPublisher(publisherId, displayName) {
            let subscriberHandle = null;
            
            janus.attach({
                plugin: 'janus.plugin.videoroom',
                success: function(pluginHandle) {
                    subscriberHandle = pluginHandle;
                    
                    const subscribeMsg = {
                        request: 'join',
                        room: parseInt(roomIdInput.value),
                        ptype: 'subscriber',
                        feed: publisherId
                    };
                    
                    subscriberHandle.send({ message: subscribeMsg });
                },
                error: function(error) {
                    log('è¨‚é–±å¤±æ•—: ' + error);
                },
                onmessage: function(msg, jsep) {
                    if (msg.videoroom === 'attached') {
                        const startMsg = { request: 'start' };
                        subscriberHandle.send({ message: startMsg });
                    }
                    
                    if (jsep) {
                        subscriberHandle.createAnswer({
                            jsep: jsep,
                            media: { audioSend: false, videoSend: false },
                            success: function(answerJsep) {
                                const startMsg = { request: 'start', room: parseInt(roomIdInput.value) };
                                subscriberHandle.send({ message: startMsg, jsep: answerJsep });
                            },
                            error: function(error) {
                                log('WebRTC é€£æ¥å¤±æ•—: ' + error);
                            }
                        });
                    }
                },
                onremotestream: function(stream) {
                    log(`æ”¶åˆ° ${displayName} çš„è¦–è¨Š`);
                    addRemoteVideo(publisherId, displayName, stream);
                },
                onremotetrack: function(track, mid, on, metadata) {
                    // æ‰‹å‹•çµ„åˆåª’é«”æµï¼ˆæŸäº› Janus ç‰ˆæœ¬éœ€è¦ï¼‰
                    if (metadata && metadata.reason === 'unmute' && on) {
                        setTimeout(() => {
                            createRemoteStreamFromTracks(publisherId, displayName, subscriberHandle);
                        }, 500);
                    }
                }
            });
        }
        
        // å¾è»Œé“æ‰‹å‹•å‰µå»ºé ç¨‹åª’é«”æµ
        function createRemoteStreamFromTracks(publisherId, displayName, subscriberHandle) {
            try {
                const pc = subscriberHandle.webrtcStuff.pc;
                if (!pc) return;
                
                const receivers = pc.getReceivers();
                if (receivers.length === 0) return;
                
                const remoteStream = new MediaStream();
                let addedTracks = 0;
                
                receivers.forEach(receiver => {
                    if (receiver.track && receiver.track.readyState === 'live') {
                        remoteStream.addTrack(receiver.track);
                        addedTracks++;
                    }
                });
                
                if (addedTracks > 0) {
                    log(`æ”¶åˆ° ${displayName} çš„è¦–è¨Šæµ`);
                    addRemoteVideo(publisherId, displayName, remoteStream);
                }
            } catch (error) {
                log('è¦–è¨Šæµè™•ç†éŒ¯èª¤: ' + error.message);
            }
        }
        
        // æ·»åŠ é ç¨‹è¦–è¨Š
        function addRemoteVideo(publisherId, displayName, stream) {
            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
            if (document.getElementById(`remote_${publisherId}`)) {
                return;
            }
            
            const videoContainer = document.createElement('div');
            videoContainer.className = 'video-container';
            videoContainer.id = `remote_${publisherId}`;
            
            const video = document.createElement('video');
            video.autoplay = true;
            video.playsinline = true;
            video.muted = false;
            video.srcObject = stream;
            
            // å‰µå»ºè¦–è¨Šç¦ç”¨é®ç½©
            const disabledOverlay = document.createElement('div');
            disabledOverlay.className = 'video-disabled';
            disabledOverlay.style.display = 'none';
            disabledOverlay.innerHTML = `
                ğŸ“·<br>
                <strong>${displayName}</strong><br>
                <small>è¦–è¨Šå·²é—œé–‰</small>
            `;
            
            const label = document.createElement('div');
            label.className = 'video-label';
            label.textContent = displayName;
            
            // ç›£è½è¦–è¨Šè»Œé“ç‹€æ…‹è®ŠåŒ–
            const videoTracks = stream.getVideoTracks();
            if (videoTracks.length > 0) {
                const videoTrack = videoTracks[0];
                let isVideoDisabled = false;
                let muteTimeout = null;
                
                // ç›£è½è»Œé“è®Šæ›´äº‹ä»¶
                videoTrack.addEventListener('mute', () => {
                    console.log(`Video track muted for ${displayName}`);
                    isVideoDisabled = true;
                    disabledOverlay.style.display = 'flex';
                    
                    // æ¸…é™¤ä¹‹å‰çš„è¶…æ™‚
                    if (muteTimeout) {
                        clearTimeout(muteTimeout);
                    }
                    
                    // è¨­ç½®è¶…æ™‚ï¼šå¦‚æœ3ç§’å¾Œæ²’æœ‰ unmuteï¼Œä¿æŒç¦ç”¨ç‹€æ…‹
                    muteTimeout = setTimeout(() => {
                        if (isVideoDisabled) {
                            console.log(`Video remains muted for ${displayName}`);
                            disabledOverlay.style.display = 'flex';
                        }
                    }, 3000);
                });
                
                videoTrack.addEventListener('unmute', () => {
                    console.log(`Video track unmuted for ${displayName}`);
                    isVideoDisabled = false;
                    disabledOverlay.style.display = 'none';
                    
                    // æ¸…é™¤è¶…æ™‚
                    if (muteTimeout) {
                        clearTimeout(muteTimeout);
                        muteTimeout = null;
                    }
                });
            }
            
            videoContainer.appendChild(video);
            videoContainer.appendChild(disabledOverlay);
            videoContainer.appendChild(label);
            videoGrid.appendChild(videoContainer);
            
            remoteStreams[publisherId] = stream;
        }
        
        // ç§»é™¤é ç¨‹è¦–è¨Š
        function removeRemoteVideo(publisherId) {
            const videoContainer = document.getElementById(`remote_${publisherId}`);
            if (videoContainer) {
                videoContainer.remove();
            }
            delete remoteStreams[publisherId];
        }
        
        // é›¢é–‹æˆ¿é–“
        function leaveRoom() {
            log('æ­£åœ¨é›¢é–‹æˆ¿é–“...');
            
            if (videoRoomHandle) {
                videoRoomHandle.send({ message: { request: 'leave' } });
                videoRoomHandle.detach();
                videoRoomHandle = null;
            }
            
            // åœæ­¢æœ¬åœ°åª’é«”æµ
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
                localVideo.srcObject = null;
            }
            
            // æ¸…é™¤é ç¨‹è¦–è¨Š
            Object.keys(remoteStreams).forEach(publisherId => {
                removeRemoteVideo(publisherId);
            });
            remoteStreams = {};
            
            // æ¸…ç©ºæˆ¿é–“ç‹€æ…‹
            currentRoomId = null;
            roomParticipants.clear();
            
            // é‡ç½®æœ¬åœ°è¦–è¨Šé®ç½©
            localVideoDisabled.style.display = 'none';
            isVideoMuted = false;
            isAudioMuted = false;
            
            // ç¦ç”¨èŠå¤©åŠŸèƒ½å’Œé›¢é–‹ TextRoom
            leaveTextRoom();
            chatInput.disabled = true;
            sendBtn.disabled = true;
            chatMessages.innerHTML = '';
            currentUserId = null;
            currentUserName = null;
            
            // æ¸…ç†èŠå¤©ç›¸é—œçš„ localStorage
            localStorage.removeItem('webrtc_chat_broadcast');
            
            resetUI();
            updateRoomStatus('', false);
            log('å·²é›¢é–‹æˆ¿é–“');
        }
        
        // èŠå¤©ç›¸é—œå‡½æ•¸
        function addSystemMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message system';
            messageDiv.style.background = '#ffc107';
            messageDiv.style.color = '#333';
            messageDiv.style.textAlign = 'center';
            messageDiv.style.fontStyle = 'italic';
            messageDiv.innerHTML = `
                <div class="content">${message}</div>
                <div class="time">${new Date().toLocaleTimeString()}</div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function addChatMessage(senderId, senderName, message, isOwnMessage = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${isOwnMessage ? 'own' : 'other'}`;
            
            messageDiv.innerHTML = `
                ${!isOwnMessage ? `<div class="sender">${senderName}</div>` : ''}
                <div class="content">${message}</div>
                <div class="time">${new Date().toLocaleTimeString()}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // å·²å®Œå…¨ç§»é™¤ TextRoom èŠå¤©ç³»çµ±ï¼Œçµ±ä¸€ä½¿ç”¨ VideoRoom display æ–¹æ¡ˆ
        // 
        // ç§»é™¤çš„ TextRoom å‡½æ•¸ï¼š
        // - setupTextRoom() 
        // - joinTextRoom()
        // - diagnoseTextRoomStatus()
        // - handleTextRoomMessage()
        // - handleTextRoomJsep()
        // - leaveTextRoom()
        //
        // èŠå¤©åŠŸèƒ½ç¾åœ¨å®Œå…¨ä¾è³´ VideoRoom çš„ display å±¬æ€§æ›´æ–°æ©Ÿåˆ¶
        
        // æ‰€æœ‰ TextRoom å‡½æ•¸å·²æ›¿æ›ç‚º no-op å¯¦ç¾ï¼Œé˜²æ­¢éŒ¯èª¤å‘¼å«
        function setupTextRoom() { return; }
        function joinTextRoom() { return; }  
        function diagnoseTextRoomStatus() { return; }
        function joinTextRoomForMessaging() { return; }
        function handleTextRoomMessage() { return; }
        function handleTextRoomJsep() { return; }
        function leaveTextRoom() { return; }
        function setupDataChannelConnection() { return; }
        
        // === ä»¥ä¸‹ç‚º sendChatMessage ç›¸é—œå‡½æ•¸ ===
        
        function sendChatMessage() {
                    
                    // TextRoom 0.0.2 ç‰ˆæœ¬ï¼šç›´æ¥é€²è¡Œ setup
                    joinTextRoom(roomId, username);
                },
                error: function(error) {
                    log('TextRoom æ’ä»¶é€£æ¥å¤±æ•—: ' + error);
                    log('å¯èƒ½åŸå› :');
                    log('1. Janus æœå‹™å™¨æœªå•Ÿç”¨ TextRoom æ’ä»¶');
                    log('2. TextRoom æ’ä»¶ç‰ˆæœ¬ä¸å…¼å®¹');
                    log('3. Janus Gateway é…ç½®å•é¡Œ');
                    log('è‡ªå‹•åˆ‡æ›åˆ°å‚™ç”¨èŠå¤©æ–¹æ¡ˆ');
                    // ä½¿ç”¨å‚™ç”¨èŠå¤©æ–¹æ¡ˆ
                    setupFallbackChat();
                },
                onmessage: function(msg, jsep) {
                    handleTextRoomMessage(msg);
                    handleTextRoomJsep(jsep);
                },
                ondataopen: function(data) {
                    log('TextRoom æ•¸æ“šé€šé“å·²é–‹å•Ÿ - å¯ä»¥ç™¼é€æ•¸æ“šäº†');
                    log(`æ•¸æ“šé€šé“è©³æƒ…: ${JSON.stringify(data)}`);
                    textRoomDataChannelOpen = true;
                },
                ondata: function(data) {
                    log('æ”¶åˆ° TextRoom æ•¸æ“šé€šé“è¨Šæ¯: ' + data, LOG_LEVELS.DEBUG);
                    try {
                        const chatData = JSON.parse(data);
                        log(`è§£æèŠå¤©æ•¸æ“š: ${JSON.stringify(chatData)}`);
                        
                        // æª¢æŸ¥å¤šç¨®å¯èƒ½çš„è¨Šæ¯æ ¼å¼
                        const senderName = chatData.username || chatData.from || chatData.user;
                        const messageText = chatData.message || chatData.text || chatData.msg;
                        
                        if (senderName && senderName !== currentUserName && messageText) {
                            addChatMessage(senderName, senderName, messageText, false);
                            log(`é€šé TextRoom DataChannel æ”¶åˆ°ä¾†è‡ª ${senderName} çš„è¨Šæ¯: ${messageText}`);
                        } else {
                            log(`è¨Šæ¯éæ¿¾æˆ–æ ¼å¼ä¸åŒ¹é…: ç™¼é€è€…=${senderName}, å…§å®¹=${messageText}`);
                        }
                    } catch (error) {
                        log('è§£æ TextRoom æ•¸æ“šé€šé“è¨Šæ¯å¤±æ•—: ' + error);
                        log('åŸå§‹æ•¸æ“š: ' + data);
                    }
                },
                // æ·»åŠ é¡å¤–çš„äº‹ä»¶è™•ç†å™¨ï¼Œä»¥é˜² TextRoom 0.0.2 ä½¿ç”¨ä¸åŒçš„äº‹ä»¶æ©Ÿåˆ¶
                ondatachannel: function(datachannel) {
                    log('æ”¶åˆ° DataChannel å°è±¡: ' + datachannel);
                    if (datachannel && datachannel.onmessage) {
                        datachannel.onmessage = function(event) {
                            log('é€šéåŸç”Ÿ DataChannel æ”¶åˆ°è¨Šæ¯: ' + event.data);
                            try {
                                const chatData = JSON.parse(event.data);
                                const senderName = chatData.username || chatData.from || chatData.user;
                                const messageText = chatData.message || chatData.text || chatData.msg;
                                
                                if (senderName && senderName !== currentUserName && messageText) {
                                    addChatMessage(senderName, senderName, messageText, false);
                                    log(`é€šéåŸç”Ÿ DataChannel æ”¶åˆ°ä¾†è‡ª ${senderName} çš„è¨Šæ¯: ${messageText}`);
                                }
                            } catch (error) {
                                log('è§£æåŸç”Ÿ DataChannel è¨Šæ¯å¤±æ•—: ' + error);
                            }
                        };
                    }
                }
            });
        }
        
        // åŠ å…¥ TextRoom èŠå¤©æˆ¿é–“
        function joinTextRoom(roomId, username) {
            if (!textRoomHandle) return;
            
            log('æ¸¬è©¦ TextRoom 0.0.2 æ”¯æ´çš„ API è«‹æ±‚...', LOG_LEVELS.DEBUG);
            
            // æ¸¬è©¦ TextRoom 0.0.2 çš„åŸºæœ¬è«‹æ±‚
            const testRequests = [
                { request: "list" },  // åˆ—å‡ºæˆ¿é–“
                { request: "exists", room: parseInt(roomId) },  // æª¢æŸ¥æˆ¿é–“æ˜¯å¦å­˜åœ¨  
                { request: "listparticipants", room: parseInt(roomId) },  // åˆ—å‡ºåƒèˆ‡è€…
                { request: "edit", room: parseInt(roomId), new_description: "æ¸¬è©¦æˆ¿é–“" },  // æ¸¬è©¦ç·¨è¼¯
                {}  // ç©ºè«‹æ±‚
            ];
            
            let testIndex = 0;
            
            function testNextRequest() {
                if (testIndex >= testRequests.length) {
                    log('API æ¸¬è©¦å®Œæˆï¼ŒTextRoom ä¸æ”¯æ´å¤šç”¨æˆ¶èŠå¤©ï¼Œå°‡ä½¿ç”¨ VideoRoom æ›¿ä»£æ–¹æ¡ˆ');
                    setupFallbackChat();
                    return;
                }
                
                const testMsg = { ...testRequests[testIndex] };
                
                // ç‚º room 1234 æ·»åŠ å¯†é‘°
                const roomSecret = getRoomSecret(roomId);
                if (roomSecret !== null && testMsg.room) {
                    testMsg.secret = roomSecret;
                }
                
                log(`æ¸¬è©¦è«‹æ±‚ ${testIndex + 1}: ${JSON.stringify(testMsg)}`, LOG_LEVELS.DEBUG);
                
                textRoomHandle.send({
                    message: testMsg,
                    success: function(result) {
                        log(`æ¸¬è©¦ ${testIndex + 1} çµæœ: ${JSON.stringify(result)}`, LOG_LEVELS.DEBUG);
                        
                        if (result && !result.error_code) {
                            log(`æ‰¾åˆ°å¯ç”¨çš„ API è«‹æ±‚ï¼ä½† TextRoom 0.0.2 ä¸æ”¯æ´å¤šç”¨æˆ¶èŠå¤©ï¼Œä½¿ç”¨ VideoRoom æ›¿ä»£æ–¹æ¡ˆ`);
                            setupFallbackChat();
                            return;
                        }
                        
                        testIndex++;
                        testNextRequest();
                    },
                    error: function(error) {
                        log(`æ¸¬è©¦ ${testIndex + 1} éŒ¯èª¤: ${error}`);
                        testIndex++;
                        testNextRequest();
                    }
                });
            }
            
            testNextRequest();
        }
        
        // è¨ºæ–· TextRoom ç‹€æ…‹
        function diagnoseTextRoomStatus(roomId) {
            if (!textRoomHandle) return;
            
            log('=== TextRoom ç‹€æ…‹è¨ºæ–· ===');
            
            // å†æ¬¡æŸ¥è©¢æˆ¿é–“è³‡è¨Š
            textRoomHandle.send({
                message: { request: "list" },
                success: function(result) {
                    log(`æˆ¿é–“åˆ—è¡¨: ${JSON.stringify(result)}`);
                    
                    if (result && result.list) {
                        const room = result.list.find(r => r.room == roomId);
                        if (room) {
                            log(`æˆ¿é–“ ${roomId} ç‹€æ…‹:`);
                            log(`- åƒèˆ‡è€…æ•¸é‡: ${room.num_participants}`);
                            log(`- æ­·å²è¨Šæ¯: ${room.history}`);
                            log(`- éœ€è¦å¯†ç¢¼: ${room.pin_required}`);
                        }
                    }
                }
            });
            
            // æŸ¥è©¢æˆ¿é–“åƒèˆ‡è€…
            const roomSecret = getRoomSecret(roomId);
            const participantsMsg = { 
                request: "listparticipants", 
                room: parseInt(roomId) 
            };
            if (roomSecret !== null) {
                participantsMsg.secret = roomSecret;
            }
            
            textRoomHandle.send({
                message: participantsMsg,
                success: function(result) {
                    log(`æˆ¿é–“ ${roomId} åƒèˆ‡è€…: ${JSON.stringify(result)}`);
                },
                error: function(error) {
                    log(`æŸ¥è©¢åƒèˆ‡è€…å¤±æ•—: ${error}`);
                }
            });
        }
        
        // DataChannel å»ºç«‹æˆåŠŸå¾ŒåŠ å…¥æˆ¿é–“ä»¥æ¥æ”¶è¨Šæ¯
        function joinTextRoomForMessaging(roomId, username) {
            if (!textRoomHandle) return;
            
            log(`å˜—è©¦åŠ å…¥ TextRoom ${roomId} ä»¥æ¥æ”¶è¨Šæ¯...`);
            
            const joinMsg = {
                request: "join",
                room: parseInt(roomId),
                username: username || currentUserName || `user_${Date.now()}`,
                display: username || currentUserName || `User ${Date.now()}`
            };
            
            // ç‚º room 1234 æ·»åŠ å¯†é‘°
            const roomSecret = getRoomSecret(roomId);
            if (roomSecret !== null) {
                joinMsg.secret = roomSecret;
            }
            
            log(`ç™¼é€ join è«‹æ±‚: ${JSON.stringify(joinMsg)}`, LOG_LEVELS.DEBUG);
            
            textRoomHandle.send({
                message: joinMsg,
                success: function(result) {
                    log(`Join çµæœ: ${JSON.stringify(result)}`, LOG_LEVELS.DEBUG);
                    
                    if (result && result.error_code) {
                        log(`Join å¤±æ•—: ${result.error} (code: ${result.error_code})`, LOG_LEVELS.DEBUG);
                        if (result.error_code === 415) {
                            log('TextRoom 0.0.2 å¯èƒ½ä¸éœ€è¦æ˜ç¢ºçš„ join è«‹æ±‚ï¼ŒDataChannel æ‡‰è©²å·²ç¶“å¯ä»¥æ”¶ç™¼è¨Šæ¯');
                        }
                    } else {
                        log('æˆåŠŸåŠ å…¥ TextRoomï¼Œç¾åœ¨å¯ä»¥æ”¶ç™¼è¨Šæ¯');
                    }
                },
                error: function(error) {
                    log(`Join è«‹æ±‚å¤±æ•—: ${error}`);
                    log('å³ä½¿ join å¤±æ•—ï¼ŒDataChannel å¯èƒ½ä»å¯æ­£å¸¸å·¥ä½œ');
                }
            });
        }
        
        // è¨­ç½® DataChannel é€£æ¥
        function setupDataChannelConnection(roomId, username) {
            log(`ç›´æ¥å»ºç«‹ TextRoom DataChannel é€£æ¥...`);
            
            // TextRoom 0.0.2 å¯èƒ½ä¸éœ€è¦ç‰¹å®šçš„ API è«‹æ±‚ï¼Œç›´æ¥å»ºç«‹ DataChannel
            textRoomHandle.createOffer({
                media: { audio: false, video: false, data: true },
                success: function(jsep) {
                    log('TextRoom DataChannel Offer å‰µå»ºæˆåŠŸ');
                    log('JSEP Offer: ' + JSON.stringify(jsep));
                    
                    // å˜—è©¦ä¸åŒçš„ DataChannel å»ºç«‹æ–¹å¼
                    const connectionAttempts = [
                        // æ–¹å¼1: ä½¿ç”¨ setup è«‹æ±‚å»ºç«‹ DataChannel
                        { 
                            message: { 
                                request: "setup",
                                room: parseInt(roomId)
                            }, 
                            jsep: jsep 
                        },
                        // æ–¹å¼2: ä½¿ç”¨ join è«‹æ±‚
                        { 
                            message: { 
                                request: "join",
                                room: parseInt(roomId),
                                username: username || `user_${Date.now()}`,
                                display: username || `User ${Date.now()}`
                            }, 
                            jsep: jsep 
                        },
                        // æ–¹å¼3: ä½¿ç”¨ create è«‹æ±‚
                        {
                            message: {
                                request: "create", 
                                room: parseInt(roomId),
                                description: `èŠå¤©æˆ¿é–“ ${roomId}`
                            },
                            jsep: jsep
                        }
                    ];
                    
                    let attemptIndex = 0;
                    
                    function tryNextConnection() {
                        if (attemptIndex >= connectionAttempts.length) {
                            log('æ‰€æœ‰ DataChannel é€£æ¥å˜—è©¦éƒ½å¤±æ•—ï¼Œä½¿ç”¨å‚™ç”¨æ–¹æ¡ˆ');
                            setupFallbackChat();
                            return;
                        }
                        
                        const attempt = { ...connectionAttempts[attemptIndex] };
                        
                        // ç‚º room 1234 æ·»åŠ å¯†é‘°
                        const roomSecret = getRoomSecret(roomId);
                        if (roomSecret !== null && attempt.message) {
                            attempt.message.secret = roomSecret;
                        }
                        
                        log(`DataChannel é€£æ¥å˜—è©¦ ${attemptIndex + 1}: ${JSON.stringify(attempt.message)}`);
                        
                        textRoomHandle.send({
                            ...attempt,
                            success: function(result) {
                                log(`DataChannel å˜—è©¦ ${attemptIndex + 1} çµæœ: ${JSON.stringify(result)}`);
                                
                                if (result && result.error_code) {
                                    log(`å˜—è©¦ ${attemptIndex + 1} å¤±æ•—: ${result.error}`);
                                    attemptIndex++;
                                    tryNextConnection();
                                } else {
                                    log(`DataChannel å˜—è©¦ ${attemptIndex + 1} æˆåŠŸï¼`);
                                    textRoomDataChannelOpen = true;
                                    log('TextRoom DataChannel å·²é–‹å•Ÿï¼ŒèŠå¤©åŠŸèƒ½å¯ç”¨');
                                    
                                    // è¨ºæ–· TextRoom ç‹€æ…‹
                                    diagnoseTextRoomStatus(roomId);
                                    
                                    // DataChannel å»ºç«‹æˆåŠŸå¾Œï¼Œå˜—è©¦åŠ å…¥æˆ¿é–“ä»¥æ¥æ”¶å…¶ä»–ç”¨æˆ¶çš„è¨Šæ¯
                                    joinTextRoomForMessaging(roomId, username);
                                }
                            },
                            error: function(error) {
                                log(`DataChannel å˜—è©¦ ${attemptIndex + 1} éŒ¯èª¤: ${error}`);
                                attemptIndex++;
                                tryNextConnection();
                            }
                        });
                    }
                    
                    tryNextConnection();
                },
                error: function(error) {
                    log('TextRoom DataChannel Offer å‰µå»ºå¤±æ•—: ' + error);
                    setupFallbackChat();
                }
            });
        }
        
        // è™•ç† TextRoom è¨Šæ¯
        function handleTextRoomMessage(msg) {
            log('TextRoom æ”¶åˆ°è¨Šæ¯: ' + JSON.stringify(msg));
            
            const event = msg.textroom;
            log(`TextRoom äº‹ä»¶é¡å‹: ${event}`);
            
            if (event === 'joined') {
                log(`æˆåŠŸåŠ å…¥ TextRoomï¼Œç”¨æˆ¶å: ${msg.username}`);
                if (msg.participants) {
                    log(`æˆ¿é–“å…§ç¾æœ‰ç”¨æˆ¶: ${msg.participants.map(p => p.username).join(', ')}`);
                }
            } else if (event === 'join') {
                if (msg.username !== currentUserName) {
                    addSystemMessage(`${msg.username} åŠ å…¥äº†èŠå¤©å®¤`);
                    log(`${msg.username} åŠ å…¥äº†èŠå¤©å®¤`);
                }
            } else if (event === 'leave') {
                if (msg.username !== currentUserName) {
                    addSystemMessage(`${msg.username} é›¢é–‹äº†èŠå¤©å®¤`);
                    log(`${msg.username} é›¢é–‹äº†èŠå¤©å®¤`);
                }
            } else if (event === 'message' || event === 'announcement' || event === 'sent' || event === 'received') {
                log(`æ”¶åˆ°èŠå¤©è¨Šæ¯äº‹ä»¶ï¼`);
                log(`äº‹ä»¶: ${event}`);
                log(`å®Œæ•´è¨Šæ¯: ${JSON.stringify(msg)}`);
                
                // TextRoom çš„è¨Šæ¯æ ¼å¼å¯èƒ½ä¸åŒï¼Œæª¢æŸ¥å¤šç¨®å¯èƒ½çš„å­—æ®µ
                const senderName = msg.from || msg.username || msg.sender || msg.display;
                const messageText = msg.text || msg.message || msg.content;
                
                log(`è§£æçµæœ - ç™¼é€è€…: ${senderName}, å…§å®¹: ${messageText}`);
                
                if (senderName && senderName !== currentUserName && messageText) {
                    addChatMessage(senderName, senderName, messageText, false);
                    log(`æˆåŠŸé¡¯ç¤ºä¾†è‡ª ${senderName} çš„è¨Šæ¯: ${messageText}`);
                } else {
                    log(`è¨Šæ¯éæ¿¾æˆ–è§£æå¤±æ•—:`);
                    log(`- ç™¼é€è€…: ${senderName} (ç•¶å‰ç”¨æˆ¶: ${currentUserName})`);
                    log(`- å…§å®¹: ${messageText}`);
                    log(`- æ˜¯å¦ç‚ºè‡ªå·±çš„è¨Šæ¯: ${senderName === currentUserName}`);
                }
            } else if (event === 'error') {
                log(`TextRoom éŒ¯èª¤: ${msg.error}`);
                if (msg.error_code) {
                    log(`éŒ¯èª¤ä»£ç¢¼: ${msg.error_code}`);
                }
            } else if (event === 'success') {
                log(`TextRoom æ“ä½œæˆåŠŸ`);
            } else if (event === 'setup') {
                log('TextRoom setup å®Œæˆï¼Œæº–å‚™å»ºç«‹ DataChannel');
            } else {
                log(`æœªè™•ç†çš„ TextRoom äº‹ä»¶: ${event}`);
                log(`å®Œæ•´è¨Šæ¯å…§å®¹: ${JSON.stringify(msg)}`);
            }
        }
        
        // è™•ç† TextRoom JSEP (ç”¨æ–¼ DataChannel å»ºç«‹)
        function handleTextRoomJsep(jsep) {
            if (jsep) {
                log('æ”¶åˆ° TextRoom JSEPï¼Œè™•ç† answer');
                textRoomHandle.handleRemoteJsep({
                    jsep: jsep,
                    success: function() {
                        log('TextRoom DataChannel é€£æ¥å»ºç«‹æˆåŠŸ');
                    },
                    error: function(error) {
                        log('TextRoom DataChannel å»ºç«‹å¤±æ•—: ' + error);
                    }
                });
            }
        }
        
        // é›¢é–‹ TextRoom
        function leaveTextRoom() {
            if (textRoomHandle) {
                const leaveMsg = {
                    request: 'leave'
                };
                
                // æ·»åŠ æˆ¿é–“å¯†é‘°ï¼ˆå¦‚æœéœ€è¦ï¼‰
                const roomSecret = getRoomSecret(currentRoomId);
                if (roomSecret !== null) {
                    leaveMsg.secret = roomSecret;
                }
                
                textRoomHandle.send({ message: leaveMsg });
                textRoomHandle.detach();
                textRoomHandle = null;
                log('å·²é›¢é–‹ TextRoom èŠå¤©');
            }
        }
        
        // å˜—è©¦åŸºæœ¬çš„æ–‡å­—ç™¼é€æ–¹æ³•
        function tryBasicTextSend(message) {
            if (!textRoomHandle) {
                log('TextRoom handle ä¸å­˜åœ¨ï¼Œä½¿ç”¨å‚™ç”¨æ–¹æ¡ˆ');
                broadcastChatMessage(message, currentUserName, currentUserId);
                return;
            }
            
            // å˜—è©¦ä¸åŒçš„è«‹æ±‚æ ¼å¼
            const basicRequests = [
                { request: 'text', text: message },
                { request: 'post', text: message },
                { text: message }, // ç„¡è«‹æ±‚é¡å‹
            ];
            
            let requestIndex = 0;
            
            function tryNextRequest() {
                if (requestIndex >= basicRequests.length) {
                    log('TextRoom è«‹æ±‚éƒ½å¤±æ•—ï¼Œä½¿ç”¨ VideoRoom èŠå¤©æ–¹æ¡ˆ');
                    sendChatViaVideoRoom(message);
                    return;
                }
                
                const testMsg = { ...basicRequests[requestIndex] };
                testMsg.room = parseInt(currentRoomId);
                
                // æ·»åŠ å¯†é‘°
                const roomSecret = getRoomSecret(currentRoomId);
                if (roomSecret !== null) {
                    testMsg.secret = roomSecret;
                }
                
                log(`å˜—è©¦åŸºæœ¬è«‹æ±‚ ${requestIndex + 1}: ${JSON.stringify(testMsg)}`);
                
                textRoomHandle.send({
                    message: testMsg,
                    success: function(result) {
                        if (result && result.error_code) {
                            log(`åŸºæœ¬è«‹æ±‚ ${requestIndex + 1} å¤±æ•—: ${result.error}`);
                            requestIndex++;
                            tryNextRequest();
                        } else {
                            log(`åŸºæœ¬è«‹æ±‚ ${requestIndex + 1} æˆåŠŸï¼`);
                        }
                    },
                    error: function(error) {
                        log(`åŸºæœ¬è«‹æ±‚ ${requestIndex + 1} éŒ¯èª¤: ${error}`);
                        requestIndex++;
                        tryNextRequest();
                    }
                });
            }
            
            tryNextRequest();
        }
        
        // TextRoom ç›¸é—œå‡½æ•¸å·²ç§»é™¤ï¼Œç¾åœ¨çµ±ä¸€ä½¿ç”¨ VideoRoom èŠå¤©æ–¹æ¡ˆ
        
        // è¨­ç½®åŸºæ–¼ Janus WebSocket çš„èŠå¤©ç³»çµ±
        
        // å‚™ç”¨èŠå¤©æ–¹æ¡ˆï¼ˆå¦‚æœ TextRoom ä¸å¯ç”¨ï¼‰
        function setupFallbackChat() {
            log('TextRoom ä¸å¯ç”¨ï¼Œå•Ÿç”¨å‚™ç”¨èŠå¤©æ–¹æ¡ˆ');
            
            // å•Ÿç”¨ localStorage å’Œ BroadcastChannel èŠå¤©
            if (window.BroadcastChannel && !window.chatChannel) {
                window.chatChannel = new BroadcastChannel('webrtc-chat');
                window.chatChannel.addEventListener('message', function(event) {
                    const data = event.data;
                    if (data.type === 'chat' && 
                        data.room === currentRoomId && 
                        data.userId !== currentUserId) {
                        addChatMessage(data.userId, data.username, data.text, false);
                        log(`æ”¶åˆ°ä¾†è‡ª ${data.username} çš„å‚™ç”¨èŠå¤©è¨Šæ¯: ${data.text}`);
                    } else if (data.type === 'user_joined' && data.userId !== currentUserId) {
                        addSystemMessage(`${data.username} åŠ å…¥äº†èŠå¤©å®¤ï¼ˆæœ¬åœ°æ¨¡å¼ï¼‰`);
                    } else if (data.type === 'user_left' && data.userId !== currentUserId) {
                        addSystemMessage(`${data.username} é›¢é–‹äº†èŠå¤©å®¤ï¼ˆæœ¬åœ°æ¨¡å¼ï¼‰`);
                    }
                });
                
                // å»£æ’­ç”¨æˆ¶åŠ å…¥äº‹ä»¶
                window.chatChannel.postMessage({
                    type: 'user_joined',
                    room: currentRoomId,
                    username: currentUserName,
                    userId: currentUserId,
                    timestamp: Date.now()
                });
            }
            
            log('å‚™ç”¨èŠå¤©æ–¹æ¡ˆå·²å•Ÿç”¨ï¼ˆæ”¯æ´åŒæ©Ÿå™¨å¤šæ¨™ç±¤é èŠå¤©ï¼‰');
        }
        
        function sendChatMessage() {
            const message = chatInput.value.trim();
            if (!message || !currentRoomId) return;
            
            // é¡¯ç¤ºè‡ªå·±çš„è¨Šæ¯
            addChatMessage(currentUserId, currentUserName, message, true);
            
            // TextRoom 0.0.2 ä¸æ”¯æ´å¤šç”¨æˆ¶èŠå¤©ï¼Œä½¿ç”¨ VideoRoom æ›¿ä»£æ–¹æ¡ˆ
            if (videoRoomHandle) {
                log(`ä½¿ç”¨ VideoRoom ç™¼é€èŠå¤©è¨Šæ¯: ${message}`);
                sendChatViaVideoRoom(message);
            } else {
                log('VideoRoom ä¸å¯ç”¨ï¼Œä½¿ç”¨å‚™ç”¨æ–¹æ¡ˆ');
                broadcastChatMessage(message, currentUserName, currentUserId);
            }
            
            chatInput.value = '';
        }
        
        // ä½¿ç”¨ VideoRoom ç™¼é€èŠå¤©è¨Šæ¯
        function sendChatViaVideoRoom(message) {
            if (!videoRoomHandle || !currentRoomId || !currentUserName) {
                log('VideoRoom èŠå¤©ç™¼é€å¤±æ•—ï¼šç¼ºå°‘å¿…è¦åƒæ•¸');
                broadcastChatMessage(message, currentUserName, currentUserId);
                return;
            }
            
            // VideoRoom configure ä¸æœƒå»£æ’­ display è®ŠåŒ–ï¼Œæ”¹ç”¨ publish é‡æ–°ç™¼å¸ƒ
            const chatPayload = {
                type: 'chat',
                message: message,
                sender: currentUserName,
                timestamp: Date.now(),
                messageId: generateUUIDv7()  // ä½¿ç”¨å…¨åŸŸå”¯ä¸€ ID
            };
            
            const newDisplay = `${currentUserName}|CHAT:${JSON.stringify(chatPayload)}`;
            
            log(`ç™¼é€èŠå¤©è¨Šæ¯: "${message}"`, LOG_LEVELS.INFO);
            
            // ç›´æ¥ä½¿ç”¨ configure display æ–¹æ³•ï¼ˆå› ç‚º VideoRoom ä¸æ”¯æ´è‡ªå®šç¾© message è«‹æ±‚ï¼‰
            attemptRepublish();
            
            function attemptRepublish() {
                // ä½¿ç”¨ configure æ›´æ–° displayï¼Œè€Œä¸æ˜¯é‡æ–°ç™¼å¸ƒ
                const configureMsg = { 
                    request: 'configure',
                    display: newDisplay
                };
                
                log(`å˜—è©¦é€šé configure æ›´æ–° display: ${JSON.stringify(configureMsg)}`, LOG_LEVELS.DEBUG);
                
                videoRoomHandle.send({ 
                    message: configureMsg,
                    success: function(result) {
                        log(`Configure display çµæœ: ${JSON.stringify(result)}`, LOG_LEVELS.DEBUG);
                        
                        if (result && result.error_code) {
                            log(`Configure display è¢«æ‹’çµ•: ${result.error}ï¼Œä½¿ç”¨å‚™ç”¨æ–¹æ¡ˆ`);
                            broadcastChatMessage(message, currentUserName, currentUserId);
                        } else {
                            log('Display æ›´æ–°ç™¼é€æˆåŠŸ');
                            
                            // åˆ†å±¤å¼é‡è¤‡ç™¼é€ä»¥æé«˜å¯é æ€§
                            const retryDisplayUpdate = (attempt) => {
                                if (attempt > 3) return; // æœ€å¤šé‡è©¦3æ¬¡
                                
                                setTimeout(() => {
                                    log(`ç¬¬ ${attempt} æ¬¡é‡è¤‡ç™¼é€ display æ›´æ–°`, LOG_LEVELS.DEBUG);
                                    videoRoomHandle.send({
                                        message: {
                                            request: 'configure',
                                            display: newDisplay
                                        },
                                        success: function(result) {
                                            log(`ç¬¬ ${attempt} æ¬¡ç™¼é€æˆåŠŸ`, LOG_LEVELS.DEBUG);
                                        },
                                        error: function(error) {
                                            log(`ç¬¬ ${attempt} æ¬¡ç™¼é€å¤±æ•—: ${error}`);
                                            retryDisplayUpdate(attempt + 1);
                                        }
                                    });
                                }, attempt * 800);
                            };
                            
                            retryDisplayUpdate(1);
                            
                            // åªè¨­ç½®ä¸€æ¬¡æ¢å¾© timeoutï¼Œé¿å…é‡è¤‡
                            if (!displayRestoreTimeout) {
                                displayRestoreTimeout = setTimeout(() => {
                                    log('ç¾åœ¨æ¢å¾©åŸå§‹ display');
                                    videoRoomHandle.send({ 
                                        message: { 
                                            request: 'configure', 
                                            display: currentUserName 
                                        },
                                        success: function(restoreResult) {
                                            log(`åŸå§‹ display æ¢å¾©çµæœ: ${JSON.stringify(restoreResult)}`, LOG_LEVELS.DEBUG);
                                        }
                                    });
                                    displayRestoreTimeout = null; // é‡ç½® timeout è¿½è¹¤
                                }, 8000);
                            }
                        }
                    },
                    error: function(error) {
                        log(`Configure display è«‹æ±‚å¤±æ•—: ${error}`);
                        broadcastChatMessage(message, currentUserName, currentUserId);
                    }
                });
            }
        }
        
        // å·²ç§»é™¤ TextRoom DataChannel ç™¼é€åŠŸèƒ½ï¼Œçµ±ä¸€ä½¿ç”¨ VideoRoom display æ–¹æ¡ˆ
        
        // è™•ç†èŠå¤©è¨Šæ¯
        function processChatMessage(displayName, publisherId) {
            if (!displayName || !displayName.includes('|CHAT:')) return;
            
            try {
                const parts = displayName.split('|CHAT:');
                if (parts.length !== 2) return;
                
                let chatData;
                const chatPart = parts[1];
                
                try {
                    // å˜—è©¦ç›´æ¥è§£æ JSON
                    chatData = JSON.parse(chatPart);
                } catch {
                    // å¦‚æœå¤±æ•—ï¼Œå˜—è©¦ base64 è§£ç¢¼å¾Œè§£æ
                    const chatDataStr = atob(chatPart);
                    chatData = JSON.parse(chatDataStr);
                }
                
                log(`è§£æåˆ°èŠå¤©æ•¸æ“š: ${JSON.stringify(chatData)}`, LOG_LEVELS.DEBUG);
                
                // ä½¿ç”¨è¨Šæ¯å…§å»ºçš„å”¯ä¸€ IDï¼Œå¦‚æœæ²’æœ‰å‰‡å›é€€åˆ°èˆŠæ–¹æ¡ˆ
                const messageId = chatData.messageId || `${chatData.sender || chatData.username}_${chatData.timestamp}`;
                
                // æª¢æŸ¥æ˜¯å¦å·²è™•ç†éæ­¤è¨Šæ¯
                if (processedMessages.has(messageId)) {
                    log(`è·³éé‡è¤‡è¨Šæ¯: ${messageId}`, LOG_LEVELS.DEBUG);
                    return;
                }
                
                // è¨˜éŒ„å·²è™•ç†çš„è¨Šæ¯
                processedMessages.set(messageId, Date.now());
                log(`æ–°è¨Šæ¯å·²è¨˜éŒ„: ${messageId}`, LOG_LEVELS.DEBUG);
                
                // æª¢æŸ¥æ¶ˆæ¯ç™¼é€è€…ï¼Œé¿å…é¡¯ç¤ºè‡ªå·±çš„è¨Šæ¯
                if (chatData.sender && chatData.sender !== currentUserName && chatData.type === 'chat') {
                    addChatMessage(chatData.sender, chatData.sender, chatData.message, false);
                    log(`æ”¶åˆ°ä¾†è‡ª ${chatData.sender} çš„è¨Šæ¯: ${chatData.message}`);
                } else if (chatData.userId && chatData.userId !== currentUserId && chatData.type === 'chat') {
                    // å…¼å®¹èˆŠæ ¼å¼
                    addChatMessage(chatData.userId, chatData.username, chatData.text, false);
                    log(`æ”¶åˆ°ä¾†è‡ª ${chatData.username} çš„è¨Šæ¯: ${chatData.text}`);
                } else {
                    log(`éæ¿¾è‡ªå·±çš„è¨Šæ¯æˆ–éèŠå¤©è¨Šæ¯: sender=${chatData.sender}, currentUser=${currentUserName}`, LOG_LEVELS.DEBUG);
                }
            } catch (error) {
                log(`èŠå¤©è¨Šæ¯è§£æå¤±æ•—: ${error}`);
                log(`åŸå§‹ displayName: ${displayName}`);
            }
        }
        
        // ç²å–æ¸…ç†å¾Œçš„é¡¯ç¤ºåç¨±
        function getCleanDisplayName(displayName) {
            if (!displayName) return 'Unknown';
            if (displayName.includes('|CHAT:')) {
                return displayName.split('|CHAT:')[0];
            }
            return displayName;
        }
        
        // å‚™ç”¨èŠå¤©è¨Šæ¯å»£æ’­ï¼ˆç”¨æ–¼ TextRoom ä¸å¯ç”¨æ™‚ï¼‰
        function broadcastChatMessage(message, senderName, senderId) {
            const chatData = {
                type: 'chat',
                room: currentRoomId,
                username: senderName,
                userId: senderId,
                text: message,
                timestamp: Date.now(),
                messageId: generateUUIDv7()  // å‚™ç”¨æ–¹æ¡ˆä¹Ÿä½¿ç”¨å”¯ä¸€ ID
            };
            
            // ä½¿ç”¨ BroadcastChannelï¼ˆå¦‚æœæ”¯æ´ï¼‰
            if (window.chatChannel) {
                window.chatChannel.postMessage(chatData);
                log(`é€šé BroadcastChannel å»£æ’­è¨Šæ¯: ${message}`);
            }
            
            // åŒæ™‚ä½¿ç”¨ localStorage ä½œç‚ºå‚™ç”¨
            localStorage.setItem('webrtc_chat_broadcast', JSON.stringify(chatData));
            
            // æ¨¡æ“¬å»¶é²å¾Œçš„å›è¦†ï¼ˆåƒ…ç”¨æ–¼æ¼”ç¤ºå–®ç”¨æˆ¶æ¸¬è©¦ï¼‰
            setTimeout(() => {
                if (Math.random() > 0.7) { // 30% æ©Ÿç‡æ¨¡æ“¬å›è¦†
                    const responses = [
                        'æ”¶åˆ°ä½ çš„è¨Šæ¯äº†ï¼',
                        'ğŸ‘',
                        'å¥½çš„',
                        'äº†è§£',
                        `å›è¦†ï¼š${message.slice(0, 10)}...`
                    ];
                    const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                    addChatMessage('demo_user', 'æ¼”ç¤ºç”¨æˆ¶', randomResponse, false);
                }
            }, 2000 + Math.random() * 3000);
        }
        
        // ç›£è½å…¶ä»–æ¨™ç±¤é çš„èŠå¤©è¨Šæ¯
        window.addEventListener('storage', function(e) {
            if (e.key === 'webrtc_chat_broadcast' && e.newValue && currentRoomId) {
                try {
                    const chatData = JSON.parse(e.newValue);
                    // åªæ¥æ”¶ç›¸åŒæˆ¿é–“ä¸”ä¸æ˜¯è‡ªå·±ç™¼é€çš„è¨Šæ¯
                    if (chatData.type === 'chat' && 
                        chatData.room === currentRoomId && 
                        chatData.userId !== currentUserId) {
                        addChatMessage(chatData.userId, chatData.username, chatData.text, false);
                        log(`æ”¶åˆ°ä¾†è‡ª ${chatData.username} çš„è¨Šæ¯: ${chatData.text}`);
                    }
                } catch (error) {
                    log('è™•ç†èŠå¤©è¨Šæ¯å¤±æ•—: ' + error.message);
                }
            }
        });
        
        // åˆ‡æ›éœéŸ³
        function toggleMute() {
            if (!localStream || !videoRoomHandle) return;
            
            isAudioMuted = !isAudioMuted;
            
            // æ›´æ–°æœ¬åœ°è»Œé“ç‹€æ…‹
            const audioTrack = localStream.getAudioTracks()[0];
            if (audioTrack) {
                audioTrack.enabled = !isAudioMuted;
            }
            
            // é€šçŸ¥ Janus Gateway æ›´æ–°éŸ³è¨Šç‹€æ…‹
            const configureMsg = {
                request: 'configure',
                audio: !isAudioMuted,
                video: !isVideoMuted
            };
            
            videoRoomHandle.send({ message: configureMsg });
            
            muteBtn.textContent = isAudioMuted ? 'å–æ¶ˆéœéŸ³' : 'éœéŸ³';
            log(isAudioMuted ? 'å·²éœéŸ³' : 'å·²å–æ¶ˆéœéŸ³');
        }
        
        // åˆ‡æ›è¦–è¨Š
        function toggleVideo() {
            if (!localStream || !videoRoomHandle) return;
            
            isVideoMuted = !isVideoMuted;
            
            // æ›´æ–°æœ¬åœ°è»Œé“ç‹€æ…‹
            const videoTrack = localStream.getVideoTracks()[0];
            if (videoTrack) {
                videoTrack.enabled = !isVideoMuted;
            }
            
            // æ›´æ–°æœ¬åœ°è¦–è¨Šé®ç½©é¡¯ç¤º
            if (isVideoMuted) {
                localVideoDisabled.style.display = 'flex';
            } else {
                localVideoDisabled.style.display = 'none';
            }
            
            // é€šçŸ¥ Janus Gateway æ›´æ–°è¦–è¨Šç‹€æ…‹
            const configureMsg = {
                request: 'configure',
                audio: !isAudioMuted,
                video: !isVideoMuted
            };
            
            videoRoomHandle.send({ message: configureMsg });
            
            videoBtn.textContent = isVideoMuted ? 'é–‹å•Ÿè¦–è¨Š' : 'é—œé–‰è¦–è¨Š';
            log(isVideoMuted ? 'å·²é—œé–‰è¦–è¨Š' : 'å·²é–‹å•Ÿè¦–è¨Š');
        }
        
        // äº‹ä»¶ç›£è½å™¨
        joinBtn.addEventListener('click', joinRoom);
        leaveBtn.addEventListener('click', leaveRoom);
        muteBtn.addEventListener('click', toggleMute);
        videoBtn.addEventListener('click', toggleVideo);
        sendBtn.addEventListener('click', sendChatMessage);
        
        // Enter éµç™¼é€è¨Šæ¯
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendChatMessage();
            }
        });
        
        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('load', function() {
            log('æ­£åœ¨åˆå§‹åŒ–è¦–è¨ŠèŠå¤©å®¤...');
            initJanus();
        });
        
        // é é¢é—œé–‰æ™‚æ¸…ç†
        window.addEventListener('beforeunload', function() {
            if (janus) {
                janus.destroy();
            }
        });
    </script>
</body>
</html>